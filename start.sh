#!/bin/bash
# ::: Code Generated by Copilot 4d5e6f78-9012-3456-789a-bcdef0123456. This comment will be removed automatically after the file is saved :::

set -e

echo "ğŸš€ Starting Kafka Management UI (Docker Mode)"
echo "=============================================="

# Check if Docker is running
if ! docker info >/dev/null 2>&1; then
    echo "âŒ Docker is not running. Please start Docker and try again."
    exit 1
fi

# Stop any existing local containers that might conflict
echo "ğŸ§¹ Cleaning up any existing containers..."
docker stop kafka-local zookeeper-local 2>/dev/null || true
docker rm kafka-local zookeeper-local 2>/dev/null || true

# Build and start all services
echo "ğŸ“¦ Building and starting services..."
docker-compose down -v 2>/dev/null || true
docker-compose up --build -d

echo "â³ Waiting for services to be ready..."

# Wait for Kafka to be healthy with better error handling
echo "ğŸ” Checking Kafka health..."
timeout=180
counter=0
while [ $counter -lt $timeout ]; do
    if docker-compose exec -T kafka kafka-broker-api-versions --bootstrap-server localhost:9092 >/dev/null 2>&1; then
        echo "âœ… Kafka is ready!"
        break
    fi
    echo "â³ Waiting for Kafka... ($counter/$timeout)"
    sleep 3
    counter=$((counter + 3))
done

if [ $counter -ge $timeout ]; then
    echo "âŒ Kafka failed to start within $timeout seconds"
    echo "ğŸ“‹ Checking logs:"
    docker-compose logs kafka --tail=20
    exit 1
fi

# Wait for UI to be ready
echo "ğŸ” Checking UI health..."
timeout=20
counter=0
while [ $counter -lt $timeout ]; do
    if curl -f http://localhost:3333/api/info >/dev/null 2>&1; then
        echo "âœ… UI is ready!"
        break
    fi
    echo "â³ Waiting for UI... ($counter/$timeout)"
    sleep 3
    counter=$((counter + 3))
done

if [ $counter -ge $timeout ]; then
    echo "âŒ UI failed to start within $timeout seconds"
    echo "ğŸ“‹ Checking logs:"
    docker-compose logs kafka-ui --tail=20
    exit 1
fi

echo ""
echo "ğŸ‰ Kafka Management UI is ready!"
echo "=================================="
echo "ğŸŒ Open your browser and go to: http://localhost:3333"
echo ""
echo "ğŸ“‹ Available services:"
echo "   â€¢ Kafka UI:       http://localhost:3333"
echo "   â€¢ Kafka Broker:   localhost:9092"
echo "   â€¢ Zookeeper:      localhost:2181"
echo ""
echo "ğŸ› ï¸  Useful commands:"
echo "   â€¢ View logs:      docker-compose logs -f"
echo "   â€¢ Stop services:  docker-compose down"
echo "   â€¢ Restart:        docker-compose restart"
echo ""
echo "âœ¨ Features available in the UI:"
echo "   ğŸ“Š Overview Dashboard with metrics"
echo "   ğŸ“ Topic Management (create, delete, view)"
echo "   ğŸ“¤ Message Producer"
echo "   ğŸ“¥ Real-time Message Consumer"
echo "   ğŸ‘¥ Consumer Group Monitoring"
echo "   ğŸ¥ Cluster Health Monitoring"
echo "   ğŸŒ™ Light/Dark Theme Toggle"
echo ""
